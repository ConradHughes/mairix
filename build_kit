#!/usr/bin/env perl

# Work out the name of the directory and hence the version

# Have to run it in the current directory
if ($0 ne "build_kit") {
  die "Have to be in the checked-out directory to run build_kit";
}

$here=`pwd`;
chomp $here;
$version=$here;
$version =~ s,^.*/mairix-([^/]+)$,$1, || die "Didn't recognize directory name";
print "Building kit for version $version\n";

system("make -f Makefile.in mairix.txt");

# Overwrite normal version.h file with version-specific one
open (OUT, ">version.txt");
print OUT $version."\n";
close OUT;

open (IN, "<mairix.spec.sample");
open (OUT, ">mairix.spec");
while (<IN>) {
  s/\@\@VERSION\@\@/$version/;
  print OUT;
}
close (IN);
close (OUT);

unlink "build_kit";
unlink "mairix.spec.sample";

system ("rm -rf dfasyn/{arch}");
system ("rm -rf ./{arch}");
system ("rm -rf dfasyn/.arch-ids");
system ("rm -rf ./.arch-ids");

chdir ("..");
system ("tar cvf - mairix-$version | gzip -9 > mairix-$version.tar.gz");
system ("gpg -b -a -o mairix-$version-tar-gz-asc.txt mairix-$version.tar.gz");

